#安装R
#对win在计算机-属性-环境变量-高级中，在path添加R的路径（直接添加"C:/R-4.0.1/bin"）
#先在官网下载tar.gz
tar -zxvf R-3.5.1.tar.gz 
cd R-3.5.1
./configure --prefix=/ifs1/Grp6/yuxin
make  #由于没有权限，故只能make，而非sudo make
make install 

PATH=$PATH:/ifs1/Grp6/yuxin/R-4.0.2/bin
PATH=$PATH:/ifs1/Grp6/yuxin/bin

export PATH="$PATH:/ifs1/Grp6/yuxin/yuxin_R/bin"

cd /ifs1/Grp6/yuxin/yuxin_R/bin

vi /etc/profile
#https://blog.csdn.net/DreamWeaver_zhou/article/details/86538490
vi/profile
export R_HOME=/ifs1/Grp6/yuxin/yuxin_R
export PATH=$PATH:$R_HOME/bin
source  profile

##https://www.cnblogs.com/youyoui/p/10680329.html
#临时配置
export PATH=/ifs1/Grp6/yuxin/yuxin_R/bin:$PATH

install.packages("BiocManager", repos = 'https://mirrors.tuna.tsinghua.edu.cn/CRAN')
#或者离线安装R CMD INSTALL clue_0.3-54.tar.gz

#安装python3
pip install wheel
pip install rpy2

#首先对文件进行处理
sce.integrated4_HC <- subset(sce.integrated4, idents="HC",invert = FALSE)
a <- as(sce.integrated4_HC@assays$RNA@counts, "matrix")
count_norm_HC <- apply(a, 2, function(x) (x/sum(x))*10000)
meta_data <- data.frame(cell_type= c(sce.integrated4_HC@meta.data$celltype.stim))
rownames(meta_data) <- rownames(sce.integrated4_HC@meta.data)
write.table(count_norm_HC, "count_norm_HC.txt", sep="\t", quote=F)
write.table(meta_data, file="meta_data_HC.txt", sep="\t", quote=F)
#注意，meta_data需要手动给第一格添加名称cell

#进入linux
#总体参考https://www.biorxiv.org/content/10.1101/680926v1.full.pdf
#https://github.com/Teichlab/cellphonedb

source cpdb-venv/bin/activate
##对于大数据，最好加入subsampling，10000取3000，总时长大概1-2h
cellphonedb method statistical_analysis meta_data_BD.txt count_norm_BD.txt --counts-data=gene_name --subsampling  --project-name=statistical_analysis_BD --subsampling-log false
##进而得到mean.txt + pvalue

#下游处理(绘图)
cellphonedb plot dot_plot --means-path=./out/statistical_analysis_BD/means.txt --pvalues-path=./out/statistical_analysis_BD/pvalues.txt --output-path=./out/statistical_analysis_BD
cellphonedb plot heatmap_plot meta_data_BD.txt --pvalues-path=./out/statistical_analysis_BD/pvalues.txt

deactivate #关闭虚拟环境



